<%# BAREOS CLIENT TEMPLATE %>
# Generated by Chef for <%= @bareos_client %>-fd
# Local modifications will be overwritten.
#
# Bareos Client Configuration File

Client {
  Name = <%= @bareos_client %>-fd
  Address = <%= @bareos_client %>
  FDPort = <%= node['bareos']['clients']['fd_port'] %>
  Catalog = <%= node['bareos']['database']['catalog_name'] %>
  Password = "<%= node['bareos']['fd_password'] %>"          # password for FileDaemon
  File Retention = <%= node['bareos']['clients']['file_retention'] %>
  Job Retention = <%= node['bareos']['clients']['job_retention'] %>
  AutoPrune = <%= node['bareos']['clients']['autoprune'] %>
  Maximum Concurrent Jobs = <%= node['bareos']['clients']['max_concurrent_jobs'] %>
}

JobDefs {
  Name = "<%= @bareos_client %>-JobDef"
  Type = Backup
  Level = Incremental
  Client = <%= @bareos_client %>-fd
  FileSet = "<%= node['bareos']['clients']['jobdef_default_fileset'] %>"
  Schedule = "<%= node['bareos']['clients']['jobdef_default_schedule'] %>"
  Storage = <%= node['bareos']['clients']['jobdef_default_storage'] %>
  Messages = <%= node['bareos']['clients']['jobdef_default_messages'] %>
  Pool = <%= node['bareos']['clients']['default_pool'] %>
  # Each client can have its own Pool to help with certain cases
<% if node['bareos']['clients']['host_pools'] == '1' %>
  FullBackupPool = <%= @client_full_pool %>
  IncrementalBackupPool = <%= @client_inc_pool %>
  DifferentialBackupPool = <%= @client_diff_pool %>
<% elsif node['bareos']['clients']['host_pools'] == '0' %>
  FullBackupPool = <%= node['bareos']['clients']['full_pool'] %>
  IncrementalBackupPool = <%= node['bareos']['clients']['incremental_pool'] %>
  DifferentialBackupPool = <%= node['bareos']['clients']['differential_pool'] %>
<% else %>
  # FullBackupPool = <%= node['bareos']['clients']['full_pool'] %>
  # IncrementalBackupPool = <%= node['bareos']['clients']['incremental_pool'] %>
  # DifferentialBackupPool = <%= node['bareos']['clients']['differential_pool'] %>
<% end %>
  Priority = <%= node['bareos']['clients']['jobdef_default_runlevel'] %>
  Write Bootstrap = "/var/lib/bareos/%c.bsr"
}

# Default Job
Job {
  Name = "<%= @bareos_client %>-Job"
  JobDefs = "<%= @bareos_client %>-JobDef"
}

# Restore Job
Job {
  Name = "<%= @bareos_client %>-Restore"
  Type = Restore
  Client = <%= @bareos_client %>-fd
  FileSet= "Full Set"
  Storage = File
<% if node['bareos']['clients']['host_pools'] == '1' %>
  Pool = <%= @client_full_pool %>
<% else %>
  Pool = <%= node['bareos']['clients']['full_pool'] %>
<% end %>
  Messages = Standard
  Where = /tmp/<%= @bareos_client %>_restored/
}
<% if node['bareos']['clients']['enable_vfulls'] == '1' %>

# VirtualFull Job
  <%# Need some logic here to determine whether to use %>
  <%# VirtualFull backups or not %>
<% end %>
<% if node['bareos']['clients']['host_pools'] == '1' %>

# Individual host pools for better tape library/storage utilization
Pool {
  Name = <%= @client_full_pool %>
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 1 year
}

Pool {
  Name = <%= @client_inc_pool %>
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 30 days
}

Pool {
  Name = <%= @client_diff_pool %>
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 3 months
}
<% end %>
