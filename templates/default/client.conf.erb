<%# BAREOS CLIENT TEMPLATE %>
# Generated by Chef for <%= @bareos_client %>-fd
# Local modifications will be overwritten.
#
# Bareos Client Configuration File

Client {
  Name = <%= @bareos_client['fqdn'] %>-fd
  Address = <%= @bareos_client['fqdn'] %>
  FDPort = <%= node['bareos']['clients']['fd_port'] %>
  Catalog = <%= node['bareos']['database']['catalog_name'] %>
  Password = "<%= @bareos_client['bareos']['fd_password'] %>" # password for FileDaemon
  File Retention = <%= node['bareos']['clients']['file_retention'] %>
  Job Retention = <%= node['bareos']['clients']['job_retention'] %>
  AutoPrune = <%= node['bareos']['clients']['autoprune'] %>
  Maximum Concurrent Jobs = <%= node['bareos']['clients']['max_concurrent_jobs'] %>
}

JobDefs {
  Name = "<%= @bareos_client['fqdn'] %>-JobDef"
  Type = Backup
  Level = Incremental
  Client = <%= @bareos_client['fqdn'] %>-fd
  FileSet = "<%= @bareos_client['fqdn'] %>-Fileset"
  Schedule = "<%= node['bareos']['clients']['jobdef_default_schedule'] %>"
  Storage = <%= node['bareos']['clients']['jobdef_default_storage'] %>
  Messages = <%= node['bareos']['clients']['jobdef_default_messages'] %>
  Pool = <%= node['bareos']['clients']['default_pool'] %>
  FullBackupPool = <%= node['bareos']['clients']['full_pool'] %>
  IncrementalBackupPool = <%= node['bareos']['clients']['incremental_pool'] %>
  DifferentialBackupPool = <%= node['bareos']['clients']['differential_pool'] %>
  Priority = <%= node['bareos']['clients']['jobdef_default_runlevel'] %>
  Write Bootstrap = "/var/lib/bareos/%c.bsr"
  SpoolData = <%= node['bareos']['clients']['spool_data'] %>
}

# Default Job
Job {
  Name = "<%= @bareos_client['fqdn'] %>-Job"
  JobDefs = "<%= @bareos_client['fqdn'] %>-JobDef"
}

# Restore Job
Job {
  Name = "<%= @bareos_client['fqdn'] %>-Restore"
  Type = Restore
  Client = <%= @bareos_client['fqdn'] %>-fd
  FileSet = "<%= @bareos_client['fqdn'] %>-Fileset"
  Storage = <%= node['bareos']['clients']['storage'] %>
  Pool = <%= node['bareos']['clients']['full_pool'] %>
  Messages = <%= node['bareos']['messages']['default_messages'] %>
  Where = /tmp/<%= @bareos_client['fqdn'] %>_restored/
}

FileSet { 
  Name = "<%= @bareos_client['fqdn'] %>-Fileset"
  Include {
    Options {
      signature = MD5
    }
    File = /
    Exclude Dir Containing = .bareos_ignore
  }
  Exclude {
    File = /var/lib/bareos
    File = /var/lib/bareos/storage
    File = /var/lib/pgsql
    File = /var/lib/mysql
    File = /proc
    File = /tmp
    File = /.journal
    File = /.fsck
    File = /spool
  }
}

<% if node['bareos']['clients']['enable_vfulls'] %>
# VirtualFull Job
Job {
  Name = "<%= @bareos_client['fqdn'] %>-VFullJob"
  Client = <%= @bareos_client['fqdn'] %>-fd
  JobDefs = "<%= @bareos_client['fqdn'] %>-VFullJobDef"
  FileSet = "<%= @bareos_client['fqdn'] %>-Fileset"
  Accurate = <%= node['bareos']['clients']['vfull_accurate'] %>
}

JobDefs {
  Name = "<%= @bareos_client['fqdn'] %>-VFullJobDef"
  Type = Backup
  Level = VirtualFull
  Client = <%= @bareos_client['fqdn'] %>-fd
  FileSet = "<%= @bareos_client['fqdn'] %>-Fileset"
  Schedule = "<%= node['bareos']['clients']['vfull_schedule'] %>"
  Storage = <%= node['bareos']['storage']['main_storage'] %>
  Messages = <%= node['bareos']['messages']['default_messages'] %>
  Pool = <%= node['bareos']['clients']['vfull_pool'] %>
  IncrementalBackupPool = <%= node['bareos']['clients']['incremental_pool'] %>
  DifferentialBackupPool = <%= node['bareos']['clients']['differential_pool'] %>
  FullBackupPool = <%= node['bareos']['clients']['full_pool'] %>
  Priority = <%= node['bareos']['clients']['vfull_priority'] %>
  Write Bootstrap = "<%= node['bareos']['clients']['bootstrap_file'] %>"
  SpoolData = <%= node['bareos']['clients']['vfull_spool'] %>
  Maximum Concurrent Jobs = <%= node['bareos']['clients']['vfull_concurrent_jobs'] %>
  Allow Duplicate Jobs = <%= node['bareos']['clients']['vfull_duplicate_jobs'] %>
  Cancel Lower Level Duplicates = <%= node['bareos']['clients']['vfull_cancel_low_duplicates'] %>
  Reschedule On Error = <%= node['bareos']['clients']['vfull_reschedule_on_fail'] %>
  Reschedule Interval = <%= node['bareos']['clients']['vfull_reschedule_interval'] %>
  Reschedule Times = <%= node['bareos']['clients']['vfull_reschedule_times'] %>
  Accurate = <%= node['bareos']['clients']['vfull_accurate'] %>
}

Schedule {
  Name = <%= node['bareos']['clients']['vfull_schedule'] %>
  Run = Level=VirtualFull on 1 at 3:00
}
<% end %>

<% if node['bareos']['clients']['host_pools'] -%>
# Individual host pools for better tape library/storage utilization
Pool {
  Name = <%= node['bareos']['clients']['default_pool'] %>
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 7 days
}

Pool {
  Name = <%= node['bareos']['clients']['full_pool'] %>
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 1 year
}

Pool {
  Name = <%= node['bareos']['clients']['incremental_pool'] %>
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 30 days
}

Pool {
  Name = <%= node['bareos']['clients']['differential_pool'] %>
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 3 months
}
<% end %>
