<%# HOST TEMPLATE %>
# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.

# This host file is generated from a chef search based on
# the bareos_base role or a custom client list in the 
# default attributes file of the chef-bareos cookbook

<% @bareos_clients.each do |client| %>
Client {
  Name = <%= client['fqdn'] %>-fd
  Address = <%= client['fqdn'] %>
  Password = "<%= client['bareos']['fd_password'] %>"          # password for FileDaemon
  File Retention = 30 days
  Job Retention = 6 months
  AutoPrune = no
}

# Each client gets its own JobDef to facilitate having
# client based pools
JobDefs {
  Name = "<%= client['hostname'] %>-Job"
  Type = Backup
  Level = Incremental
  Client = <%= client[:fqdn] %>-fd
  FileSet = "Full Set"
  Schedule = "WeeklyCycle"
  Storage = File
  Messages = Standard
  Pool = Scratch
  FullBackupPool = <%= client['hostname'] %>-Full
  IncrementalBackupPool = <%= client['hostname'] %>-Inc
  DifferentialBackupPool = <%= client['hostname'] %>-Diff
  Priority = 10
  Write Bootstrap = "/var/lib/bareos/%c.bsr"
}

# Default Job
Job {
  Name = "<%= client['hostname'] %>-Job"
  JobDefs = "<%= client['hostname'] %>-Job"
}

# Restore Job
Job {
  Name = "<%= client['hostname'] %>-Restore"
  Type = Restore
  Client = <%= client['fqdn'] %>-fd
  FileSet= "Full Set"
  Storage = File
  Pool = <%= client['hostname'] %>-Full
  Messages = Standard
  Where = /tmp/<%= client['hostname'] %>_restored/
}

# VirtualFull Job
<%# Need some logic here to determine whether to use %>
<%# VirtualFull backups or not %>

# Individual host pools for better storage utilization
<%# Could use some logic here to %>
<%# determine if seperate host pools or not %>
Pool {
  Name = <%= client['hostname'] %>-Full
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 1 year
}

Pool {
  Name = <%= client['hostname'] %>-Inc
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 30 days
}

Pool {
  Name = <%= client['hostname'] %>-Diff
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 3 months
}

<% end %>
