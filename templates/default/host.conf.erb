<%# HOST TEMPLATE %>
# Generated by Chef for <%= node['fqdn'] %>
# Local modifications will be overwritten.

<%# @bareos_clients.each do |client| %>
# Bareos Host Config for <%= node['hostname'] %>-fd

Client {
  Name = <%= node['hostname'] %>-fd
  Address = <%= node['fqdn'] %>
  Password = "<%= node['bareos']['fd_password'] %>"          # password for FileDaemon
  File Retention = 30 days
  Job Retention = 6 months
  AutoPrune = no
}

JobDefs {
  Name = "<%= node['hostname'] %>-Job"
  Type = Backup
  Level = Incremental
  Client = <%= node['hostname'] %>-fd
  FileSet = "Full Set"
  Schedule = "WeeklyCycle"
  Storage = File
  Messages = Standard
  Pool = Scratch
  # Each client can have its own Pool to help with certain cases
<% if node['bareos']['host_pools'] == true && node['bareos']['custom_host_pools'] == true %>
  FullBackupPool = <%= node['bareos']['host_full_pool'] %>
  IncrementalBackupPool = <%= node['bareos']['host_incremental_pool'] %>
  DifferentialBackupPool = <%= node['bareos']['host_differential_pool'] %>
<% elsif node['bareos']['host_pools'] == true %>
  FullBackupPool = <%= node['hostname'] %>-Full
  IncrementalBackupPool = <%= node['hostname'] %>-Inc
  DifferentialBackupPool = <%= node['hostname'] %>-Diff
<% else %>
  # FullBackupPool = <%= node['bareos']['host_full_pool'] %>
  # IncrementalBackupPool = <%= node['bareos']['host_incremental_pool'] %>
  # DifferentialBackupPool = <%= node['bareos']['host_differential_pool'] %>
<% end %>
  Priority = 10
  Write Bootstrap = "/var/lib/bareos/%c.bsr"
}

# Default Job
Job {
  Name = "<%= node['hostname'] %>-Job"
  JobDefs = "<%= node['hostname'] %>-Job"
}

# Restore Job
Job {
  Name = "<%= node['hostname'] %>-Restore"
  Type = Restore
  Client = <%= node['hostname'] %>-fd
  FileSet= "Full Set"
  Storage = File
<% if node['bareos']['host_pools'] == true && node['bareos']['custom_host_pools'] == true %>
  Pool = <%= node['bareos']['host_full_pool'] %>
<% elsif node['bareos']['host_pools'] == true %>
  Pool = <%= node['hostname'] %>-Full
<% else %>
  Pool = Default
<% end %>
  Messages = Standard
  Where = /tmp/<%= node['hostname'] %>_restored/
}

<% if node['bareos']['enable_vfulls'] == true %>
# VirtualFull Job
  <%# Need some logic here to determine whether to use %>
  <%# VirtualFull backups or not %>
<% end %>

<% if node['bareos']['host_pools'] == true %>
# Individual host pools for better storage utilization
Pool {
  <% if node['bareos']['custom_host_pools'] == true %>
  Name = <%= node['bareos']['host_full_pool'] %>
  <% else %>
  Name = <%= node['hostname'] %>-Full
  <% end %>
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 1 year
}

Pool {
  <% if node['bareos']['custom_host_pools'] == true %>
  Name = <%= node['bareos']['host_incremental_pool'] %>
  <% else %>
  Name = <%= node['hostname'] %>-Inc
  <% end %>
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 30 days
}

Pool {
  <% if node['bareos']['custom_host_pools'] == true %>
  Name = <%= node['bareos']['host_differential_pool'] %>
  <% else %>
  Name = <%= node['hostname'] %>-Diff
  <% end %>
  Pool Type = Backup
  Recycle = yes
  AutoPrune = yes
  Volume Retention = 3 months
}
<% end %>
